<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FE Shop – Thanh toán</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo">
        <span class="brand-fe">FE</span><span class="brand-shop">Shop</span>
      </a>
      <nav class="nav">
        <a href="index.html">Sản phẩm</a>
        <a href="cart.html">Giỏ hàng (<span id="cart-count">0</span>)</a>
        <a href="checkout.html" aria-current="page">Thanh toán</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <section class="hero text-center">
      <h1>Thanh toán đơn hàng</h1>
      <p class="muted">Vui lòng điền thông tin để hoàn tất</p>
    </section>

    <div class="checkout-grid">
      <!-- FORM -->
      <div class="checkout-form">
        <form id="checkoutForm">
          <h3>Thông tin nhận hàng</h3>
          <div class="form-group">
            <label>Họ và tên *</label>
            <input type="text" required placeholder="Nguyễn Văn A" />
          </div>
          <div class="form-group">
            <label>Số điện thoại *</label>
            <input type="tel" required placeholder="0901234567" />
          </div>
          <div class="form-group">
            <label>Địa chỉ *</label>
            <input type="text" required placeholder="123 Đường ABC, Quận 1" />
          </div>
          <div class="form-group">
            <label>Ghi chú (tùy chọn)</label>
            <textarea rows="3" placeholder="Giao giờ hành chính..."></textarea>
          </div>

          <h3 class="mt-4">Phương thức thanh toán</h3>
          <div class="payment-options">
            <label class="radio-label">
              <input type="radio" name="payment" value="cod" checked />
              <span>Thanh toán khi nhận hàng (COD)</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="payment" value="bank" />
              <span>Chuyển khoản ngân hàng</span>
            </label>
          </div>

          <button type="submit" class="btn w-100 mt-4">Hoàn tất đơn hàng</button>
        </form>
      </div>

      <!-- ORDER SUMMARY -->
      <div id="order-summary" class="order-summary"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container text-center">
      <p>&copy; <span id="year"></span> FE Shop. Đồ dùng học tập chất lượng.</p>
    </div>
  </footer>

  <!-- JS MODULE -->
  <script type="module">
    import { PRODUCTS } from './data/products.js';
    import { getCart, clearCart, initCartCount, cartTotal } from './js/cart.js';
    import { loadProducts, byId, formatCurrency } from './js/utils.js';

    initCartCount();
    const cart = getCart();
    const products = loadProducts(PRODUCTS); // JOIN để lấy hình, tên, giá
    const summary = byId('order-summary');
    const form = byId('checkoutForm');

    function renderSummary() {
      if (cart.length === 0) {
        summary.innerHTML = `<p class="text-center text-muted">Giỏ hàng trống</p>`;
        return;
      }

      const subtotal = cartTotal(products);
      const shipping = 30000;
      const total = subtotal + shipping;

      summary.innerHTML = `
        <div class="summary-card">
          <h3>Đơn hàng (${cart.length} sản phẩm)</h3>
          ${cart.map(item => {
            const p = products.find(pr => pr.id === item.id);
            if (!p) return '';
            return `
              <div class="order-item">
                <img src="${p.images[0]}" alt="${p.name}" class="order-thumb" loading="lazy">
                <div>
                  <p class="fw-bold">${p.name}</p>
                  <small>${p.priceFmt} × ${item.qty}</small>
                </div>
                <strong>${formatCurrency(p.price * item.qty)}</strong>
              </div>`;
          }).join('')}
          <hr>
          <div class="summary-row">
            <span>Tạm tính</span>
            <strong>${formatCurrency(subtotal)}</strong>
          </div>
          <div class="summary-row">
            <span>Phí vận chuyển</span>
            <strong>${formatCurrency(shipping)}</strong>
          </div>
          <hr>
          <div class="summary-row total">
            <span>Thành tiền</span>
            <strong class="text-danger fs-5">${formatCurrency(total)}</strong>
          </div>
        </div>`;
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (cart.length === 0) {
        alert('Giỏ hàng trống!');
        return;
      }

      alert(`Đặt hàng thành công!\nTổng tiền: ${summary.querySelector('.text-danger').textContent}\nCảm ơn bạn đã mua sắm tại FE Shop!`);
      clearCart();
      initCartCount();
      renderSummary();
      setTimeout(() => location.href = 'index.html', 1500);
    });

    renderSummary();
    byId('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>